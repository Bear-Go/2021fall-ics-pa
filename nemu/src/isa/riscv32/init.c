#include <isa.h>
#include <memory/paddr.h>

// this is not consistent with uint8_t
// but it is ok since we do not access the array directly
static const uint32_t img [] = {
// 0x00000413,//,//,//,//,//,//,//,//,//,//,//li,//s0,0
// 0x00009117,//,//,//,//,//,//,//,//,//,//,//auipc,//sp,0x9
// 0xffc10113,//,//,//,//,//,//,//,//,//,//,//addi,//sp,sp,-4,//#,//80009000,//<_end>
// 0x0e0000ef,//,//,//,//,//,//,//,//,//,//,//jal,//ra,800000ec,//<_trm_init>

// 0x00050463,//,//,//,//,//,//,//,//,//,//,//beqz,//a0,80000018,//<check+0x8>
// 0x00008067,//,//,//,//,//,//,//,//,//,//,//ret
// 0xff010113,//,//,//,//,//,//,//,//,//,//,//addi,//sp,sp,-16
// 0x00100513,//,//,//,//,//,//,//,//,//,//,//li,//a0,1
// 0x00112623,//,//,//,//,//,//,//,//,//,//,//sw,//ra,12(sp)
// 0x0bc000ef,//,//,//,//,//,//,//,//,//,//,//jal,//ra,800000e0,//<halt>

// 0xfe010113,//,//,//,//,//,//,//,//,//,//,//addi,//sp,sp,-32
// 0x00100613,//,//,//,//,//,//,//,//,//,//,//li,//a2,1
// 0x00812c23,//,//,//,//,//,//,//,//,//,//,//sw,//s0,24(sp)
// 0x00912a23,//,//,//,//,//,//,//,//,//,//,//sw,//s1,20(sp)
// 0x01212823,//,//,//,//,//,//,//,//,//,//,//sw,//s2,16(sp)
// 0x01312623,//,//,//,//,//,//,//,//,//,//,//sw,//s3,12(sp)
// 0x80000937,//,//,//,//,//,//,//,//,//,//,//lui,//s2,0x80000
// 0x00112e23,//,//,//,//,//,//,//,//,//,//,//sw,//ra,28(sp)
// 0x01e00493,//,//,//,//,//,//,//,//,//,//,//li,//s1,30
// 0x00160413,//,//,//,//,//,//,//,//,//,//,//addi,//s0,a2,1
// 0x00000993,//,//,//,//,//,//,//,//,//,//,//li,//s3,0
// 0x11090913,//,//,//,//,//,//,//,//,//,//,//addi,//s2,s2,272,//#,//80000110,//<_end+0xffff7110>
// 0x02940c63,//,//,//,//,//,//,//,//,//,//,//beq,//s0,s1,80000090,//<main+0x68>
// 0x00100793,//,//,//,//,//,//,//,//,//,//,//li,//a5,1
// 0x00000593,//,//,//,//,//,//,//,//,//,//,//li,//a1,0
// 0x02f46733,//,//,//,//,//,//,//,//,//,//,//rem,//a4,s0,a5
// 0x00178693,//,//,//,//,//,//,//,//,//,//,//addi,//a3,a5,1
// 0x00071463,//,//,//,//,//,//,//,//,//,//,//bnez,//a4,80000074,//<main+0x4c>
// 0x00f585b3,//,//,//,//,//,//,//,//,//,//,//add,//a1,a1,a5
// 0x00c78663,//,//,//,//,//,//,//,//,//,//,//beq,//a5,a2,80000080,//<main+0x58>
// 0x00068793,//,//,//,//,//,//,//,//,//,//,//mv,//a5,a3
// 0xfe9ff06f,//,//,//,//,//,//,//,//,//,//,//j,//80000064,//<main+0x3c>
// 0x02858e63,//,//,//,//,//,//,//,//,//,//,//beq,//a1,s0,800000bc,//<main+0x94>
// 0x00040613,//,//,//,//,//,//,//,//,//,//,//mv,//a2,s0
// 0x00160413,//,//,//,//,//,//,//,//,//,//,//addi,//s0,a2,1
// 0xfc9418e3,//,//,//,//,//,//,//,//,//,//,//bne,//s0,s1,8000005c,//<main+0x34>
// 0xffe98513,//,//,//,//,//,//,//,//,//,//,//addi,//a0,s3,-2
// 0x00153513,//,//,//,//,//,//,//,//,//,//,//seqz,//a0,a0
// 0xf79ff0ef,//,//,//,//,//,//,//,//,//,//,//jal,//ra,80000010,//<check>
// 0x01c12083,//,//,//,//,//,//,//,//,//,//,//lw,//ra,28(sp)
// 0x01812403,//,//,//,//,//,//,//,//,//,//,//lw,//s0,24(sp)
// 0x01412483,//,//,//,//,//,//,//,//,//,//,//lw,//s1,20(sp)
// 0x01012903,//,//,//,//,//,//,//,//,//,//,//lw,//s2,16(sp)
// 0x00c12983,//,//,//,//,//,//,//,//,//,//,//lw,//s3,12(sp)
// 0x00000513,//,//,//,//,//,//,//,//,//,//,//li,//a0,0
// 0x02010113,//,//,//,//,//,//,//,//,//,//,//addi,//sp,sp,32
// 0x00008067,//,//,//,//,//,//,//,//,//,//,//ret
// 0x00299793,//,//,//,//,//,//,//,//,//,//,//slli,//a5,s3,0x2
// 0x00f907b3,//,//,//,//,//,//,//,//,//,//,//add,//a5,s2,a5
// 0x0007a503,//,//,//,//,//,//,//,//,//,//,//lw,//a0,0(a5)
// 0x00198993,//,//,//,//,//,//,//,//,//,//,//addi,//s3,s3,1
// 0x40850533,//,//,//,//,//,//,//,//,//,//,//sub,//a0,a0,s0
// 0x00153513,//,//,//,//,//,//,//,//,//,//,//seqz,//a0,a0
// 0xf3dff0ef,//,//,//,//,//,//,//,//,//,//,//jal,//ra,80000010,//<check>
// 0x00040613,//,//,//,//,//,//,//,//,//,//,//mv,//a2,s0
// 0xfadff06f,//,//,//,//,//,//,//,//,//,//,//j,//80000088,//<main+0x60>

// 0x00050513,//,//,//,//,//,//,//,//,//,//,//mv,//a0,a0
// 0x0000006b,//,//,//,//,//,//,//,//,//,//,//0x6b
// 0x0000006f,//,//,//,//,//,//,//,//,//,//,//j,//800000e8,//<halt+0x8>

// 0x80000537,//,//,//,//,//,//,//,//,//,//,//lui,//a0,0x80000
// 0xff010113,//,//,//,//,//,//,//,//,//,//,//addi,//sp,sp,-16
// 0x10c50513,//,//,//,//,//,//,//,//,//,//,//addi,//a0,a0,268,//#,//8000010c,//<_end+0xffff710c>
// 0x00112623,//,//,//,//,//,//,//,//,//,//,//sw,//ra,12(sp)
// 0xf2dff0ef,//,//,//,//,//,//,//,//,//,//,//jal,//ra,80000028,//<main>
// 0x00050513,//,//,//,//,//,//,//,//,//,//,//mv,//a0,a0
// 0x0000006b,//,//,//,//,//,//,//,//,//,//,//0x6b
// 0x0000006f,//,//,//,//,//,//,//,//,//,//,//j,//80000108,//<_trm_init+0x1c>
//   // test by me
  0x800002b7,  // lui t0,0x80000
  0x0002a023,  // sw  zero,0(t0)
  0x0002a503,  // lw  a0,0(t0)
  0x0000006b,  // nemu_trap
};

static void restart() {
  /* Set the initial program counter. */
  cpu.pc = RESET_VECTOR;

  /* The zero register is always 0. */
  cpu.gpr[0]._32 = 0;
}

void init_isa() {
  /* Load built-in image. */
  memcpy(guest_to_host(RESET_VECTOR), img, sizeof(img));

  /* Initialize this virtual computer system. */
  restart();
}
